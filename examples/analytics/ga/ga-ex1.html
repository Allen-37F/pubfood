<!doctype html>
<head>
  <title>Pubfood - Google Analytics Ex1</title>
  <script src="../../../build/pubfood.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
  <script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
</script>
</head>
<body>
    <!-- Turn Yieldbot integration testing on  -->
    <iframe src="//i.yldbt.com/m/start-testing" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" height="0" width="0" style="display: none"></iframe>

    <script>
     // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/random#Examples
     function getRandomIntInclusive(min, max) {
         return Math.floor(Math.random() * (max - min + 1)) + min;
     }

     window.googletag = window.googletag || {};
     googletag.cmd = googletag.cmd || [];
     var ybotq = ybotq || [];

     var pfTimeReference = +new Date(),
         pf = new pubfood(),
         bidTimingHits = [];

     pf.omitDefaultBidKey(true);
     pf.timeout(1000);

     pf.observe('PUBFOOD_API_LOAD', function(ev) {
         pfTimeReference = ev.ts;
     });

     var slot = pf.addSlot({
         name: '/6355419/Travel/Europe/France/Paris',
         sizes: [
             [300, 250],
             [300, 600]
         ],
         elementId: 'div-medium-rectangle',
         bidProviders: [
             'criteo', 'sovrn'
         ]
     });

     slot.setParam('yieldbot', {
         slot: 'medrec'
     });

     pf.addBidProvider({
         name: 'yieldbot',
         libUri: '//cdn.yldbt.com/js/yieldbot.intent.js',
         init: function(slots, pushBid, done) {
             var slotMap = {};
             ybotq.push(function() {
                 yieldbot.psn('1234');

                 for (var k = 0; k < slots.length; k++) {
                     var slot = slots[k],
                         slotParams = slot.getParam('yieldbot');
                     yieldbot.defineSlot(slotParams.slot, {
                         sizes: slot.sizes
                     });
                     slotMap[slotParams.slot] = slot.name;
                 }
                 yieldbot.enableAsync();
                 yieldbot.go();
             });

             ybotq.push(function() {
                 var pageCriteria = yieldbot.getPageCriteria(),
                     pageSlots = pageCriteria !== '' ? pageCriteria.split(',') : [];
                 for (var i = 0; i < pageSlots.length; i++) {
                     var slotInfo = pageSlots[i].split(':'),
                         slot = slotInfo[0],
                         size = slotInfo[1],
                         bid = 0;

                     if (slotInfo.length && slotInfo[2]) {
                         bid = parseFloat(slotInfo[2], 10);
                     }

                     var sizes = size.split('x');
                     sizes[0] = parseInt(sizes[0], 10);
                     sizes[1] = parseInt(sizes[1], 10);

                     var bidObject = {
                         slot: slotMap[slot],
                         sizes: sizes,
                         targeting: {
                             ybot_ad: 'y',
                             ybot_slot: slot,
                             ybot_cpm: bid
                         }
                     };
                     pushBid(bidObject);
                 }

                 if (!pageCriteria) {
                     pushBid({
                         targeting: { ybot_ad: 'n' }
                     });
                 }

                 done();
             });
         },
         refresh: function(slots, pushBid, done) {
             var slotMap = {};
             ybotq.push(function() {
                 var refreshSlots = {};
                 for (var i = 0; i < slots.length; i++) {
                     var slot = slots[i],
                         slotParams = slot.getParam('yieldbot');
                     refreshSlots[slotParams.slot] = slot.sizes;
                     slotMap[slotParams.slot] = slot.name;
                 }
                 yieldbot.nextPageview(refreshSlots);
             });

             ybotq.push(function() {
                 var pageCriteria = yieldbot.getPageCriteria(),
                     pageSlots = pageCriteria !== '' ? pageCriteria.split(',') : [];
                 for (var i = 0; i < pageSlots.length; i++) {
                     var slotInfo = pageSlots[i].split(':'),
                         slot = slotInfo[0],
                         size = slotInfo[1],
                         bid = 0;

                     if (slotInfo.length && slotInfo[2]) {
                         bid = parseFloat(slotInfo[2], 10);
                     }

                     var sizes = size.split('x');
                     sizes[0] = parseInt(sizes[0], 10);
                     sizes[1] = parseInt(sizes[1], 10);

                     var bidObject = {
                         slot: slotMap[slot],
                         sizes: sizes,
                         targeting: {
                             ybot_ad: 'y',
                             ybot_slot: slot,
                             ybot_cpm: bid
                         }
                     };
                     pushBid(bidObject);
                 }

                 if (!pageCriteria) {
                     pushBid({
                         targeting: { ybot_ad: 'n' }
                     });
                 }

                 done();

             });
         }
     });

     var mockCriteoBidder = pf.addBidProvider({
         name: 'criteo',
         init: function(slots, pushBid, done) {
             setTimeout(function() {
                 for (var i in slots) {
                     pushBid({
                         slot: slots[i].name,
                         sizes: [300, 250],
                         targeting: {
                             top250: getRandomIntInclusive(0, 2)
                         },
                     });
                 }
                 done();
             }, getRandomIntInclusive(100, 400));
         },
         refresh: function(slots, pushBid, done) {
             setTimeout(function() {
                 for (var i in slots) {
                     pushBid({
                         slot: slots[i].name,
                         sizes: [300, 250],
                         targeting: {
                             top250: getRandomIntInclusive(0, 1)
                         }
                     });
                 }
                 done();
             }, getRandomIntInclusive(100, 400));
         }
     });

     var mockSovrnBidder = pf.addBidProvider({
         name: 'sovrn',
         init: function(slots, pushBid, done) {
             setTimeout(function() {
                 for (var i in slots) {
                     pushBid({
                         slot: slots[i].name,
                         sizes: [300, 250],
                         targeting: {
                             uPrice: 'sv,' + getRandomIntInclusive(0, 3)
                         }
                     });
                 }
                 done();
             }, getRandomIntInclusive(100, 400));
         },
         refresh: function(slots, pushBid, done) {
             setTimeout(function() {
                 for (var i in slots) {
                     pushBid({
                         slot: slots[i].name,
                         sizes: [300, 250],
                         targeting: {
                             uPrice: 'sv,' + getRandomIntInclusive(0, 3)
                         }
                     });
                 }
                 done();
             }, getRandomIntInclusive(100, 400));
         }
     });

     var mockAolBidder = pf.addBidProvider({
         name: 'aol',
         init: function(slots, pushBid, done) {
             setTimeout(function() {
                 pushBid({
                     sizes: [300, 250],
                     targeting: {
                         aolbid: '' + getRandomIntInclusive(0, 3) + '.50'
                     }
                 });
                 done();
             }, getRandomIntInclusive(100, 400));
         },
         refresh: function(slots, pushBid, done) {
             setTimeout(function() {
                 pushBid({ // page level bid
                     sizes: [300, 250],
                     targeting: {
                         aolbid: '' + getRandomIntInclusive(0, 3) + '.50'
                     }
                 });
                 done();
             }, getRandomIntInclusive(100, 400));
         }
     });

     pf.setAuctionProvider({
         name: 'Google',
         libUri: 'http://www.googletagservices.com/tag/js/gpt.js',
         init: function(targeting, done) {
             googletag.cmd.push(function() {
                 var slots = {};
                 for (var i = 0; i < targeting.length; i++) {
                     var tgtObject = targeting[i];
                     var gptObject;

                     if (tgtObject.name) {
                         gptObject = googletag.defineSlot(tgtObject.name, tgtObject.sizes, tgtObject.elementId)
                                              .addService(googletag.pubads());
                         slots[tgtObject.name] = gptObject;
                     } else {
                         gptObject = googletag.pubads();
                     }
                     for (var p in tgtObject.targeting) {
                         gptObject.setTargeting(p, tgtObject.targeting[p]);
                     }
                 }
                 pf.getAuctionProvider().setParam('slots', slots);
             });
             googletag.cmd.push(function() {
                 googletag.pubads().enableSingleRequest();
                 googletag.enableServices();
                 done();
             });
         },
         refresh: function(targeting, done) {
             googletag.cmd.push(function() {
                 var slots = pf.getAuctionProvider().getParam('slots');
                 for (var i = 0; i < targeting.length; i++) {
                     var tgtObject = targeting[i];
                     var gptObject;

                     if (tgtObject.name) {
                         gptObject = slots[tgtObject.name] || null;
                     } else {
                         gptObject = googletag.pubads();
                     }
                     for (var p in tgtObject.targeting) {
                         gptObject.setTargeting(p, tgtObject.targeting[p]);
                     }
                 }
                 googletag.pubads().refresh();
                 done();
             });
         }
     });

     function buildHit(ev, timeRef) {
         if (ev.data === '__default__') return null;
         var timingHit = {};
         if (ev.type === 'BID_COMPLETE') {
             timingHit = {
                 category: ev.data || 'noBidderName',
                 timingVar: '',
                 timingLabel: 'BidsComplete',
                 timingValue: ev.ts - timeRef
             };
         }
         if (ev.type === 'BID_PUSH_NEXT_LATE' || ev.type === 'BID_PUSH_NEXT') {
             var targeting = [], bidderName = ev.data.provider || 'noBidderName';

             targeting.push(ev.type === 'BID_PUSH_NEXT_LATE' ? 'Late-' + bidderName : bidderName);
             if (ev.data.targeting) {
                 for (var idx in ev.data.targeting) {
                     targeting.push(idx + '=' + ev.data.targeting[idx]);
                 }
             }
             if (ev.data.value !== 'undefined' && ev.data.value !== '') {
                 targeting.push('value=' + '' + ev.data.value);
             }

             timingHit = {
                 category: bidderName,
                 timingVar: ev.data.slot  || 'pageLevel',
                 timingLabel: targeting.join(';'),
                 timingValue: ev.ts - timeRef
             };
         }
         return timingHit;
     }

     // Add your accountId here
     ga('create','UA-69476533-3', 'auto', {'name': 'pftest'});
     ga('pftest.send', {hitType: 'pageview'});

     function sendHit(hit) {
         ga('pftest.send', {
             hitType: 'timing',
             timingCategory: hit.category,
             timingVar: hit.timingVar,
             timingValue: hit.timingValue,
             timingLabel: hit.timingLabel
         });
     }

     pf.observe('BID_PUSH_NEXT', function(ev) {
         var hit = buildHit(ev, pfTimeReference);
         if (hit) {
             console.log(JSON.stringify(hit));
             sendHit(hit);
         };
     });

     pf.observe('BID_PUSH_NEXT_LATE', function(ev) {
         var hit = buildHit(ev, pfTimeReference);
         if (hit) {
             console.log(JSON.stringify(hit));
             sendHit(hit);
         };
     });

     pf.observe('BID_COMPLETE', function(ev) {
         var hit = buildHit(ev, pfTimeReference);
         if (hit) {
             console.log(JSON.stringify(hit));
             sendHit(hit);
         };
     });

     pf.start();
    </script>

    <p></p>
    <h3>Medium Rectangle 300x250</h3>
    <div id='div-medium-rectangle'>
    </div>
    <script>
     pf.observe('AUCTION_POST_RUN', function() {
         googletag.cmd.push(function() {
             googletag.display('div-medium-rectangle');
         });
     });
    </script>
</body>
</html>
